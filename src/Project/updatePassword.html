<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskly - Update Password</title>
    <link rel="stylesheet" href="/Style/resetPassword.css">
</head>
<body>
    <div class="container">
        <div class="left-section">
            <img src="/assets/bgImage2.png" alt="Background" class="background-img">
            <div class="overlay-text">
                <h1>Organize Your Life</h1>
                <p>Simple, Seamless, Smart</p>
            </div>
        </div>

        <div class="right-section">
            <div class="form-container">
                <img src="/assets/logo.png" alt="Taskly Logo" class="logo">
                <h1 class="app-title">taskly</h1>
                <p class="subtitle">Clarity meets creativity through planning</p>

                <h2>Set New Password</h2>
                <p class="tagline">
                    Enter your new password below.
                </p>

                <form id="updatePasswordForm" class="reset-form">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required minlength="6">

                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required minlength="6">

                    <button type="submit" class="btn-primary">Update Password</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Load Supabase from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        let supabase;

        // Initialize Supabase
        async function initSupabase() {
            try {
                // Fetch config from server
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Create Supabase client
                const { createClient } = window.supabase;
                supabase = createClient(config.supabaseUrl, config.supabaseAnonKey);
                
                console.log('✅ Supabase initialized');
                
                // Check if user came from password reset email
                checkPasswordResetToken();
            } catch (error) {
                console.error('❌ Failed to initialize Supabase:', error);
                alert('Failed to connect. Please try again.');
            }
        }

        // Check if there's a valid password reset token
        async function checkPasswordResetToken() {
            // Get the hash from URL (Supabase sends token in hash)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const type = hashParams.get('type');

            // If no token or wrong type, redirect to forgot password
            if (!accessToken || type !== 'recovery') {
                console.log('❌ No valid reset token found');
                alert('Invalid or expired password reset link. Please request a new one.');
                window.location.href = '/forgot-password';
                return;
            }

            console.log('✅ Valid password reset token found');
        }

        // Handle update password form submission
        const updatePasswordForm = document.getElementById('updatePasswordForm');

        updatePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            // Validation
            if (!newPassword || !confirmPassword) {
                alert("Please fill in both password fields.");
                return;
            }

            if (newPassword.length < 6) {
                alert("Password must be at least 6 characters long.");
                return;
            }

            if (newPassword !== confirmPassword) {
                alert("Passwords do not match!");
                return;
            }

            // Show loading state
            const submitBtn = updatePasswordForm.querySelector('.btn-primary');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Updating...';
            submitBtn.disabled = true;

            try {
                // Update password using Supabase
                const { data, error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                console.log('✅ Password updated successfully');
                alert('✅ Password updated successfully! You can now sign in with your new password.');
                
                // Redirect to login page
                window.location.href = '/login';
            } catch (error) {
                console.error('❌ Error updating password:', error);
                alert(`❌ Failed to update password: ${error.message}`);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Initialize on page load
        initSupabase();
    </script>
</body>
</html>