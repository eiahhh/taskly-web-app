<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <link rel="stylesheet" href="/Style/style-ai-assistant.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>

<div class="layout">

   <!-- SIDEBAR -->
   <aside class="sidebar">
    <h1 class="logo">taskly</h1>

    <nav class="menu">
        <a href="/dashboard" class="menu-item">
            <i class="ri-dashboard-line"></i>
            <span>Dashboard</span>
        </a>
        <a href="/tasks" class="menu-item">
            <i class="ri-task-line"></i>
            <span>Tasks</span>
        </a>
        <a href="/ai-assistant" class="menu-item active">
            <i class="ri-robot-line"></i>
            <span>AI Assistant</span>
        </a>
    </nav>

    <a href="/profile" class="profile-link">
        <div class="profile">
            <i class="ri-user-line profile-icon"></i>
            <div>
                <p class="name" id="user-name">Loading...</p>
                <p class="sub">Your Profile</p>
            </div>
        </div>
    </a>

    <div class="logout">
        <button id="logoutBtn">Logout</button>
    </div>
</aside>


    <!-- MAIN CONTENT -->
    <main class="main">

        <!-- Header -->
        <header class="header">
            <div>
                <h2>AI Assistant</h2>
                <p class="subtitle">Stay on top of your goals with AI precision</p>
            </div>
            <button class="settings-btn">‚öôÔ∏è</button>
        </header>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <span>Quick Actions:</span>
            <button data-action="What tasks do I have today?">Today's Tasks</button>
            <button data-action="What should I focus on first?">Get Priorities</button>
            <button data-action="How am I doing this week?">Weekly Summary</button>
            <button data-action="What's overdue?">Overdue Tasks</button>
        </div>

        <!-- CHAT + RIGHT PANEL -->
        <div class="chat-section">

            <!-- CHAT BOX -->
            <div class="chat-container">

                <div class="chat-box" id="chat-box">

                    <div class="msg ai-msg">
                        <div class="avatar-container">
                            <i class="ri-robot-line" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <div class="bubble">
                                Hello! I'm your AI assistant. I can help you manage your tasks, check your schedule, and provide productivity insights. What would you like to know?
                            </div>
                            <p class="timestamp">AI Assistant ‚Ä¢ Just now</p>
                        </div>
                    </div>

                </div>

                <!-- CHAT INPUT -->
                <div class="chat-input">
                    <input type="text" id="user-input" placeholder="Type your message..." disabled>
                    <button id="send-btn" disabled>
                        <i class="ri-send-plane-fill"></i>
                    </button>
                </div>

            </div>

            <!-- RIGHT INFO PANEL -->
            <aside class="info-panel">

                <div class="info-box">
                    <h3>AI Assistant Info</h3>
                </div>

                <div class="info-box">
                    <h3>What I can do</h3>

                    <ul class="info-list">

                        <li>
                            <div class="icon">üìä</div>
                            <div>
                                <p class="title"><strong>Task Analysis</strong></p>
                                <p class="desc small">Analyze your tasks and provide insights</p>
                            </div>
                        </li>

                        <li>
                            <div class="icon">‚è∞</div>
                            <div>
                                <p class="title"><strong>Smart Reminders</strong></p>
                                <p class="desc small">Get personalized task recommendations</p>
                            </div>
                        </li>

                        <li>
                            <div class="icon">üìà</div>
                            <div>
                                <p class="title"><strong>Productivity Insights</strong></p>
                                <p class="desc small">Track your progress and streaks</p>
                            </div>
                        </li>

                    </ul>
                </div>

                <div class="info-box">
                    <h3>Example Questions</h3>

                    <div class="suggestion">
                        <strong>What tasks do I have today?</strong>
                    </div>

                    <div class="suggestion">
                        <strong>What should I prioritize?</strong>
                    </div>

                    <div class="suggestion">
                        <strong>How productive was I this week?</strong>
                    </div>
                </div>

                <div class="info-box">
                    <h3>Your Stats</h3>
                    <div class="stats">
                        <p>Tasks Completed <span id="stat-completed">0</span></p>
                        <p>Current Streak <span id="stat-streak">0</span></p>
                        <p>Active Tasks <span id="stat-active">0</span></p>
                    </div>
                </div>

            </aside>

</div>
</main>
</div>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
let supabase;
let currentUser = null;

// Initialize Supabase
async function initSupabase() {
    try {
        const response = await fetch('/api/config');
        const config = await response.json();
        
        const { createClient } = window.supabase;
        supabase = createClient(config.supabaseUrl, config.supabaseAnonKey);
        
        console.log('‚úÖ Supabase initialized');
        
        // Check authentication
        await checkAuth();
    } catch (error) {
        console.error('‚ùå Failed to initialize:', error);
        alert('Failed to connect. Please refresh the page.');
    }
}

// Check if user is authenticated
async function checkAuth() {
    const { data: { user }, error } = await supabase.auth.getUser();
    
    if (error || !user) {
        console.error('Not authenticated:', error);
        window.location.href = '/login';
        return;
    }
    
    currentUser = user;
    console.log('‚úÖ Current user:', currentUser);
    
    const displayName = user.user_metadata?.full_name || user.email.split('@')[0];
    document.getElementById('user-name').textContent = displayName;
    
    // Enable chat input
    document.getElementById('user-input').disabled = false;
    document.getElementById('send-btn').disabled = false;
    
    // Load user stats
    await loadUserStats();
}

// Load user statistics
async function loadUserStats() {
    try {
        // Get statistics
        const { data: stats } = await supabase
            .from('user_statistics')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        if (stats) {
            document.getElementById('stat-completed').textContent = stats.tasks_completed_total || 0;
            document.getElementById('stat-streak').textContent = stats.current_streak_days || 0;
        }

        // Get active tasks count
        const { count } = await supabase
            .from('tasks')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', currentUser.id)
            .eq('completed', false);

        document.getElementById('stat-active').textContent = count || 0;

    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// ============================================
// CHAT FUNCTIONALITY
// ============================================

const chatBox = document.getElementById('chat-box');
const input = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');

// Add a message to the chat
function addMessage(text, sender = "user") {
    const msg = document.createElement("div");
    msg.classList.add("msg", sender === "user" ? "user-msg" : "ai-msg");

    if (sender === "user") {
        msg.innerHTML = `
            <div>
                <div class="bubble">${escapeHtml(text)}</div>
                <p class="timestamp">You ‚Ä¢ Just now</p>
            </div>
            <div class="avatar-container">
                <i class="ri-user-line" style="font-size: 24px;"></i>
            </div>
        `;
    } else {
        msg.innerHTML = `
            <div class="avatar-container">
                <i class="ri-robot-line" style="font-size: 24px;"></i>
            </div>
            <div>
                <div class="bubble">${text}</div>
                <p class="timestamp">AI Assistant ‚Ä¢ Just now</p>
            </div>
        `;
    }

    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Add typing indicator
function showTypingIndicator() {
    const indicator = document.createElement("div");
    indicator.classList.add("msg", "ai-msg", "typing-indicator");
    indicator.id = "typing-indicator";
    
    indicator.innerHTML = `
        <div class="avatar-container">
            <i class="ri-robot-line" style="font-size: 24px;"></i>
        </div>
        <div>
            <div class="bubble">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    
    chatBox.appendChild(indicator);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Remove typing indicator
function hideTypingIndicator() {
    const indicator = document.getElementById("typing-indicator");
    if (indicator) {
        indicator.remove();
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get AI response from backend
async function getAIResponse(userMessage) {
    try {
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: userMessage,
                userId: currentUser.id
            })
        });

        if (!response.ok) {
            throw new Error('Failed to get AI response');
        }

        const data = await response.json();
        return data.response;

    } catch (error) {
        console.error('AI Error:', error);
        return "I'm having trouble connecting right now. Please try again in a moment.";
    }
}

// Send message
async function sendMessage() {
    const text = input.value.trim();
    if (!text) return;

    // Disable input while processing
    input.disabled = true;
    sendBtn.disabled = true;

    // Add user message
    addMessage(text, "user");
    input.value = "";

    // Show typing indicator
    showTypingIndicator();

    // Get AI response
    const aiResponse = await getAIResponse(text);
    
    // Hide typing indicator
    hideTypingIndicator();

    // Add AI response
    addMessage(aiResponse, "ai");

    // Re-enable input
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
}

// Event Listeners
sendBtn.addEventListener("click", sendMessage);

input.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
});

// Quick Action Buttons
document.querySelectorAll('.quick-actions button').forEach(btn => {
    btn.addEventListener("click", () => {
        const action = btn.getAttribute('data-action') || btn.textContent;
        input.value = action;
        sendMessage();
    });
});

// Suggestion clicks
document.querySelectorAll('.suggestion').forEach(suggestion => {
    suggestion.addEventListener('click', () => {
        const text = suggestion.querySelector('strong').textContent;
        input.value = text;
        sendMessage();
    });
});

// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
    const { error } = await supabase.auth.signOut();
    
    if (error) {
        console.error('Logout error:', error);
        alert('Failed to logout. Please try again.');
        return;
    }
    
    console.log('‚úÖ User logged out');
    window.location.href = '/login';
});

// Initialize on page load
initSupabase();
</script>
</body>
</html>