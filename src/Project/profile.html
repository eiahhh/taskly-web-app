<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskly | Profile</title>
    <link rel="stylesheet" href="public/Style/profile.css">
</head>

<body>
<div class="container">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo">taskly</div>

        <nav class="nav-menu">
            <a href="dashboard.html" class="nav-item">
                <span class="icon">„Ä∞Ô∏è</span>
                <span>Dashboard</span>
            </a>

            <a href="tasks.html" class="nav-item">
                <span class="icon">üìù</span>
                <span>Task</span>
            </a>

            <a href="aiAssistant.html" class="nav-item">
                <span class="icon">ü§ñ</span>
                <span>AI Assistant</span>
            </a>
        </nav>

        <div class="user-profile-sidebar">
            <div class="user-avatar-small" id="sidebarAvatar">BM</div>
            <div class="user-info-small">
                <div class="user-name-small" id="sidebarName">User Name</div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">

        <header class="top-bar">
            <h1 class="page-title">My Profile</h1>
            <div class="header-actions">
                <button class="icon-btn" id="notificationBtn">üîî</button>
                <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </header>

        <p class="page-subtitle">Manage your account settings and preferences</p>

        <!-- PROFILE HEADER -->
        <div class="profile-header">
            <div class="profile-left">
                <div class="profile-avatar" id="profileAvatar">UN</div>
                <div class="profile-info">
                    <h2 class="profile-name" id="profileName">
                        User Name
                    </h2>
                    <div class="profile-meta">
                        <span class="meta-item" id="profileEmail">üìß user@email.com</span>
                        <span class="meta-item" id="profileJoined">üìÖ Joined Recently</span>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <button class="edit-profile-btn" id="editProfileBtn">Edit profile</button>

                <button class="save-profile-btn" id="saveBtn" style="display:none;">Save</button>
                <button class="cancel-profile-btn" id="cancelBtn" style="display:none;">Cancel</button>
            </div>
        </div>

        <!-- PROFILE CONTENT -->
        <div class="content-grid">

            <!-- PERSONAL INFORMATION -->
            <div class="card">
                <h3 class="card-title">Personal Information</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nickname</label>
                        <input type="text" id="nickname" placeholder="Enter your nickname" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="email" placeholder="Enter your email" readonly>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="text" id="mobileNumber" placeholder="Enter your mobile number" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="bio" placeholder="Tell something about yourself" readonly></textarea>
                </div>
            </div>

            <!-- SECURITY -->
            <div class="card">
                <h3 class="card-title">Security</h3>

                <div class="security-item">
                    <div>
                        <div class="security-label">Password</div>
                        <div class="security-meta">Keep account secure</div>
                    </div>
                    <button id="changePasswordBtn" class="edit-profile-btn" style="padding:5px 10px;">Change password</button>
                </div>

                <div class="security-item">
                    <div>
                        <div class="security-label">Two-Factor Authentication</div>
                        <div class="security-meta">Add an extra layer of security</div>
                    </div>

                    <label class="toggle-switch">
                        <input type="checkbox">
                        <span class="toggle-slider round"></span>
                    </label>
                </div>
            </div>
                    
        </div>
    </main>
</div>

<!-- PASSWORD MODAL -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h2>Change Password</h2>

        <label>Current Password</label>
        <input type="password" id="newPass">

        <label>Confirm New Password</label>
        <input type="password" id="confirmPass">

        <div class="modal-actions">
            <button class="cancel-profile-btn" id="closeModal">Cancel</button>
            <button class="save-profile-btn" id="savePassword">Save</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    let supabase;

    async function initSupabase() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();

            const { createClient } = window.supabase;
            supabase = createClient(config.supabaseUrl, config.supabaseAnonKey);

            console.log("‚úî Supabase Initialized");

            loadUserProfile();
        } catch (err) {
            console.error("Supabase init failed:", err);
        }
    }

    // Load Profile Data
    async function loadUserProfile() {
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            window.location.href = "/login";
            return;
        }

        // Fill email
        document.getElementById("email").value = user.email;
        document.getElementById("profileEmail").textContent = "üìß " + user.email;

        // Load profile data from table
        const { data, error } = await supabase
            .from("profiles")
            .select("*")
            .eq("id", user.id)
            .single();

        if (error) {
            console.warn("No profile row yet, creating one...");
            return;
        }

        // Assign values
        document.getElementById("fullName").value = data.full_name || "";
        document.getElementById("nickname").value = data.nickname || "";
        document.getElementById("mobileNumber").value = data.mobile_number || "";
        document.getElementById("bio").value = data.bio || "";

        // Header + Sidebar
        updateProfileUI(data.full_name, user.email);
    }

    // Update UI (Avatar, Name)
    function updateProfileUI(fullName, email) {
        const initials = fullName
            ? fullName.split(" ").map(w => w[0]).join("").toUpperCase().slice(0, 2)
            : "UN";

        document.getElementById("profileAvatar").textContent = initials;
        document.getElementById("sidebarAvatar").textContent = initials;

        document.getElementById("profileName").textContent = fullName || "User Name";
        document.getElementById("sidebarName").textContent = fullName || "User Name";
    }

    // BUTTONS
    const editBtn = document.getElementById("editProfileBtn");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    // INPUT FIELDS
    const fields = ["fullName", "nickname", "email", "mobileNumber", "bio"]
        .map(id => document.getElementById(id));

    let originalValues = {};

    // EDIT MODE
    editBtn.addEventListener("click", () => {
        originalValues = {};
        fields.forEach(f => {
            originalValues[f.id] = f.value;
            f.removeAttribute("readonly");
            f.style.backgroundColor = "#fff";
        });

        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
        cancelBtn.style.display = "inline-block";
    });

    // SAVE PROFILE TO SUPABASE
    saveBtn.addEventListener("click", async () => {
        const { data: { user } } = await supabase.auth.getUser();

        const fullName = document.getElementById("fullName").value.trim();
        const nickname = document.getElementById("nickname").value.trim();
        const mobile = document.getElementById("mobileNumber").value.trim();
        const bio = document.getElementById("bio").value.trim();

        const { error } = await supabase
            .from("profiles")
            .upsert({
                id: user.id,
                full_name: fullName,
                nickname: nickname,
                mobile_number: mobile,
                bio: bio,
                updated_at: new Date()
            });

        if (error) {
            alert("‚ùå Failed to save profile.");
            console.error(error);
            return;
        }

        updateProfileUI(fullName, user.email);

        fields.forEach(f => {
            f.setAttribute("readonly", true);
            f.style.backgroundColor = "#fafafa";
        });

        editBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";

        alert("‚úî Profile updated successfully!");
    });

    // CANCEL EDIT
    cancelBtn.addEventListener("click", () => {
        fields.forEach(f => {
            f.value = originalValues[f.id];
            f.setAttribute("readonly", true);
            f.style.backgroundColor = "#fafafa";
        });

        editBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
    });

    // PASSWORD MODAL (unchanged)
    const modal = document.getElementById("passwordModal");
    const changeBtn = document.getElementById("changePasswordBtn");
    const closeModal = document.getElementById("closeModal");

    changeBtn.onclick = () => modal.style.display = "flex";
    closeModal.onclick = () => modal.style.display = "none";

    document.getElementById("savePassword").onclick = async () => {
        const newPass = document.getElementById("newPass").value;
        const confirmPass = document.getElementById("confirmPass").value;

        if (newPass !== confirmPass) {
            alert("Passwords do not match!");
            return;
        }

        const { error } = await supabase.auth.updateUser({ password: newPass });

        if (error) return alert("Failed to update password.");

        alert("Password updated!");
        modal.style.display = "none";
    }

    initSupabase();
</script>

</body>
</html>

