<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskly | Profile</title>
    <link rel="stylesheet" href="/Style/profile.css">

    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
</head>

<body>
<aside class="sidebar">
    <h1 class="logo">taskly</h1>

    <nav class="menu">
        <a href="/dashboard" class="menu-item">
            <i class="ri-dashboard-line"></i>
            <span>Dashboard</span>
        </a>
        <a href="/tasks" class="menu-item">
            <i class="ri-task-line"></i>
            <span>Tasks</span>
        </a>
        <a href="/ai-assistant" class="menu-item">
            <i class="ri-robot-line"></i>
            <span>AI Assistant</span>
        </a>
    </nav>

    <a href="/profile" class="profile-link">
        <div class="profile">
            <i class="ri-user-line profile-icon" id="sidebarAvatar"></i>
            <div>
                <p class="name" id="sidebarName">Loading...</p>
                <p class="sub">Your Profile</p>
            </div>
        </div>
    </a>
    
    <div class="logout">
        <button id="logoutBtn" class="edit-profile-btn" style="width:100%;">Logout</button>
    </div>
</aside>

    <main class="main-content">

        <div class="header">
        <div class="header-left">
            <h1>My Profile</h1>
            <p>Manage your account settings and preferences</p>
        </div>
        <div class="header-right">
            <button class="btn-icon">
                <i class="ri-notification-line"></i>
            </button>
            <button class="btn-icon">
                <i class="ri-settings-3-line"></i>
            </button>
        </div>
    </div>

        <div class="profile-header">
            <div class="profile-left">
                <div class="profile-avatar" id="profileAvatar">UN</div>
                <div class="profile-info">
                    <h2 class="profile-name" id="profileName">
                        User Name
                    </h2>
                    <div class="profile-meta">
                        <span class="meta-item" id="profileEmail">ðŸ“§ user@email.com</span>
                        <span class="meta-item" id="profileJoined">ðŸ“… Joined Recently</span>
                    </div>
                </div>
            </div>

            <div class="profile-actions">
                <button class="edit-profile-btn" id="editProfileBtn">Edit profile</button>

                <button class="save-profile-btn" id="saveBtn" style="display:none;">Save</button>
                <button class="cancel-profile-btn" id="cancelBtn" style="display:none;">Cancel</button>
            </div>
        </div>

        <div class="content-grid">

            <div class="card">
                <h3 class="card-title">Personal Information</h3>

                <div class="form-row">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nickname</label>
                        <input type="text" id="nickname" placeholder="Enter your nickname" readonly>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="email" placeholder="Enter your email" readonly>
                    </div>
                    <div class="form-group">
                        <label>Mobile Number</label>
                        <input type="text" id="mobileNumber" placeholder="Enter your mobile number" readonly>
                    </div>
                </div>

                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="bio" placeholder="Tell something about yourself" readonly></textarea>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Security</h3>

                <div class="security-item">
                    <div>
                        <div class="security-label">Password</div>
                        <div class="security-meta">Keep account secure</div>
                    </div>
                    <button id="changePasswordBtn" class="edit-profile-btn" style="padding:10px 22px;">Change password</button>
                </div>

                <div class="security-item">
                    <div>
                        <div class="security-label">Two-Factor Authentication</div>
                        <div class="security-meta">Add an extra layer of security</div>
                    </div>

                    <label class="toggle-switch">
                        <input type="checkbox">
                        <span class="toggle-slider round"></span>
                    </label>
                </div>
            </div>
                    
        </div>
    </main>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h2>Change Password</h2>

        <label>New Password</label>
        <input type="password" id="newPass">

        <label>Confirm New Password</label>
        <input type="password" id="confirmPass">

        <div class="modal-actions">
            <button class="cancel-profile-btn" id="closeModal">Cancel</button>
            <button class="save-profile-btn" id="savePassword">Save</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    let supabase;
    let currentUser = null;

    async function initSupabase() {
        try {
            const response = await fetch('/api/config');
            const config = await response.json();

            const { createClient } = window.supabase;
            supabase = createClient(config.supabaseUrl, config.supabaseAnonKey);

            console.log("âœ… Supabase Initialized");
            await loadUserProfile();
        } catch (err) {
            console.error("âŒ Supabase init failed:", err);
            // If API config fails, check if environment variables are set
            alert('Failed to connect to database. Please check your configuration.');
        }
    }

    // Load Profile Data
    async function loadUserProfile() {
        // 1. Get the authenticated user from Supabase Auth (System A)
        const { data: { user }, error } = await supabase.auth.getUser();

        if (error || !user) {
            console.error('Not authenticated:', error);
            window.location.href = "/login";
            return;
        }

        currentUser = user;
        console.log('âœ… Current user ID:', currentUser.id);

        // Fill email (This comes from Auth, not the profile table)
        document.getElementById("email").value = user.email;
        document.getElementById("profileEmail").textContent = "ðŸ“§ " + user.email;

        // Format joined date
        const joinedDate = new Date(user.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        document.getElementById("profileJoined").textContent = "ðŸ“… Joined " + joinedDate;

        // 2. Load profile data from 'user_profiles' table (System B)
        // We query by user_id, which matches the Auth UUID
        const { data, error: profileError } = await supabase
            .from("user_profiles") 
            .select("*")
            .eq("user_id", user.id) 
            .single();

        if (profileError) {
            console.warn("No profile row yet, using default values");
            const displayName = user.user_metadata?.full_name || user.email.split('@')[0];
            updateProfileUI(displayName, user.email);
            return;
        }

        // Assign values from database
        document.getElementById("fullName").value = data.full_name || "";
        document.getElementById("nickname").value = data.nickname || "";
        document.getElementById("mobileNumber").value = data.mobile_number || "";
        document.getElementById("bio").value = data.bio || "";

        // Update UI
        updateProfileUI(data.full_name || user.email.split('@')[0], user.email);
    }

    // Update UI (Avatar, Name)
    function updateProfileUI(fullName, email) {
        const initials = fullName
            ? fullName.split(" ").map(w => w[0]).join("").toUpperCase().slice(0, 2)
            : "UN";

        document.getElementById("profileAvatar").textContent = initials;
        document.getElementById("profileName").textContent = fullName || "User Name";
        document.getElementById("sidebarName").textContent = fullName || "User Name";
        document.getElementById("profileEmail").textContent = "ðŸ“§ " + (email || "user@email.com");
    }

    // LOGOUT FUNCTIONALITY
    document.getElementById("logoutBtn").addEventListener("click", async () => {
        const { error } = await supabase.auth.signOut();
        
        if (error) {
            console.error('Logout error:', error);
            alert('Failed to logout. Please try again.');
            return;
        }
        
        console.log('âœ… User logged out');
        window.location.href = '/login';
    });

    // BUTTONS
    const editBtn = document.getElementById("editProfileBtn");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");

    // INPUT FIELDS
    const fields = ["fullName", "nickname", "mobileNumber", "bio"]
        .map(id => document.getElementById(id));

    let originalValues = {};

    // EDIT MODE
    editBtn.addEventListener("click", () => {
        originalValues = {};
        fields.forEach(f => {
            originalValues[f.id] = f.value;
            f.removeAttribute("readonly");
            f.style.backgroundColor = "#fff";
        });

        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";
        cancelBtn.style.display = "inline-block";
    });

    // SAVE PROFILE TO SUPABASE
    saveBtn.addEventListener("click", async () => {
        if (!currentUser) {
            alert("You must be logged in to save changes.");
            return;
        }

        const fullName = document.getElementById("fullName").value.trim();
        const nickname = document.getElementById("nickname").value.trim();
        const mobile = document.getElementById("mobileNumber").value.trim();
        const bio = document.getElementById("bio").value.trim();

        // Disable button during save
        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
            const updates = {
                user_id: currentUser.id, // This links the profile to the Auth User UUID
                full_name: fullName,
                nickname: nickname,
                mobile_number: mobile,
                bio: bio,
                updated_at: new Date().toISOString()
            };

            const { error } = await supabase
                .from("user_profiles") // UPDATED TABLE NAME
                .upsert(updates, { onConflict: 'user_id' }); // Conflict checks user_id

            if (error) {
                throw error;
            }

            console.log('âœ… Profile updated successfully');
            updateProfileUI(fullName, currentUser.email);

            // Reset fields to readonly
            fields.forEach(f => {
                f.setAttribute("readonly", true);
                f.style.backgroundColor = "#fafafa";
            });

            editBtn.style.display = "inline-block";
            saveBtn.style.display = "none";
            cancelBtn.style.display = "none";

            alert("âœ… Profile updated successfully!");
        } catch (err) {
            console.error('Save error:', err);
            alert("âŒ Failed to save profile: " + err.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = "Save";
        }
    });

    // CANCEL EDIT
    cancelBtn.addEventListener("click", () => {
        fields.forEach(f => {
            f.value = originalValues[f.id];
            f.setAttribute("readonly", true);
            f.style.backgroundColor = "#fafafa";
        });

        editBtn.style.display = "inline-block";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
    });

    // PASSWORD MODAL
    const modal = document.getElementById("passwordModal");
    const changeBtn = document.getElementById("changePasswordBtn");
    const closeModal = document.getElementById("closeModal");

    changeBtn.onclick = () => modal.style.display = "flex";
    closeModal.onclick = () => {
        modal.style.display = "none";
        document.getElementById("newPass").value = "";
        document.getElementById("confirmPass").value = "";
    };

    document.getElementById("savePassword").onclick = async () => {
        const newPass = document.getElementById("newPass").value;
        const confirmPass = document.getElementById("confirmPass").value;

        if (!newPass || !confirmPass) {
            alert("Please fill in both password fields.");
            return;
        }

        if (newPass.length < 6) {
            alert("Password must be at least 6 characters long.");
            return;
        }

        if (newPass !== confirmPass) {
            alert("Passwords do not match!");
            return;
        }

        const savePasswordBtn = document.getElementById("savePassword");
        savePasswordBtn.disabled = true;
        savePasswordBtn.textContent = "Updating...";

        try {
            const { error } = await supabase.auth.updateUser({ password: newPass });

            if (error) {
                throw error;
            }

            alert("âœ… Password updated successfully!");
            modal.style.display = "none";
            document.getElementById("newPass").value = "";
            document.getElementById("confirmPass").value = "";
        } catch (err) {
            console.error('Password update error:', err);
            alert("âŒ Failed to update password: " + err.message);
        } finally {
            savePasswordBtn.disabled = false;
            savePasswordBtn.textContent = "Save";
        }
    };

    // Initialize on page load
    initSupabase();
</script>

</body>
</html>